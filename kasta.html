<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kasta - Uang Kas Digital</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jsPDF untuk ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Google untuk nama aplikasi -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #007AFF;
            --secondary: #5856D6;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --light: #F2F2F7;
            --dark: #1C1C1E;
            --gray: #8E8E93;
            --card-bg: #FFFFFF;
            --bg-color: #F2F2F7;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
            height: 100vh;
            height: 100dvh;
            position: fixed;
            width: 100%;
            padding-bottom: 70px; /* Space for bottom navigation */
        }
        
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 0 15px;
            overflow-x: hidden;
        }
        
        /* Header Styles - Lebih Tipis */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 0.5rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }
        
        .logo h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: -0.5px;
        }
        
        .logo-subtitle {
            font-size: 0.6rem;
            opacity: 0.8;
            font-weight: 400;
        }
        
        .logo-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px 10px;
            border: none;
            background: transparent;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.7rem;
            min-width: 60px;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056CC;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #30A14E;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #D70015;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #E68500;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        
        /* Main Content */
        .main-content {
            padding: 1rem 0;
            min-height: calc(100vh - 150px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            height: calc(100vh - 150px);
        }
        
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
            width: 100%;
            overflow-x: hidden;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dashboard Styles */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
            transition: transform 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-card h3 {
            font-size: 0.85rem;
            margin-bottom: 8px;
            color: var(--gray);
            font-weight: 500;
        }
        
        .stat-card .amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .stat-card p {
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .actions .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 10px;
            font-size: 0.85rem;
        }
        
        .chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .chart-container h2 {
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 1.2rem;
        }
        
        /* Form Styles */
        .form-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .form-section h2 {
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 1.2rem;
            border-bottom: 1px solid var(--light);
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 15px;
        }
        
        .transactions-table, .members-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        .transactions-table th, .transactions-table td,
        .members-table th, .members-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #E5E5EA;
            font-size: 0.85rem;
        }
        
        .transactions-table th, .members-table th {
            background-color: var(--light);
            font-weight: 600;
            color: var(--dark);
            white-space: nowrap;
        }
        
        .transactions-table tr:hover, .members-table tr:hover {
            background-color: #F9F9F9;
        }
        
        .income {
            color: var(--success);
            font-weight: 600;
        }
        
        .expense {
            color: var(--danger);
            font-weight: 600;
        }
        
        /* Member List Styles */
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--card-bg);
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .member-details {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .member-actions {
            display: flex;
            gap: 5px;
        }
        
        .payment-status {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .status-paid {
            background-color: #E8F5E9;
            color: #2E7D32;
        }
        
        .status-unpaid {
            background-color: #FFEBEE;
            color: #C62828;
        }
        
        .wa-icon {
            color: #25D366;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .wa-icon:hover {
            transform: scale(1.1);
        }
        
        /* Recent Transactions with Scroll */
        .recent-transactions-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #E5E5EA;
        }
        
        /* Footer */
        footer {
            background-color: var(--dark);
            color: white;
            text-align: center;
            padding: 1rem 0;
            font-size: 0.8rem;
            position: relative;
        }
        
        .help-center {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .help-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        .help-btn:hover {
            background: #0056CC;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--dark);
            font-weight: 700;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* Filter buttons for members */
        .filter-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .filter-btn {
            padding: 8px 12px;
            border: 1px solid #E5E5EA;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Responsive */
        @media (min-width: 480px) {
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .header-content {
                flex-wrap: nowrap;
            }
            
            .logo h1 {
                font-size: 1.6rem;
            }
        }
        
        @media (min-width: 768px) {
            .container {
                padding: 0 20px;
                max-width: 768px;
            }
            
            .stats-cards {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .main-content {
                height: calc(100vh - 160px);
            }
            
            body {
                padding-bottom: 0; /* Remove bottom padding on desktop */
            }
            
            .bottom-nav {
                display: none; /* Hide bottom nav on desktop */
            }
            
            /* Show top nav on desktop */
            .nav-tabs {
                display: flex;
                gap: 3px;
                background: rgba(255,255,255,0.2);
                border-radius: 12px;
                padding: 3px;
                margin: 10px 0;
                width: auto;
                order: 0;
                margin: 0;
            }
            
            .nav-tab {
                padding: 8px 15px;
                border: none;
                background: transparent;
                color: white;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                font-size: 0.9rem;
                white-space: nowrap;
                flex: 1;
                text-align: center;
            }
            
            .nav-tab.active {
                background: rgba(255,255,255,0.3);
            }
        }
        
        @media (max-width: 767px) {
            .nav-tabs {
                display: none; /* Hide top nav on mobile */
            }
            
            .help-center {
                position: static;
                transform: none;
                margin-top: 10px;
            }
            
            .help-btn {
                margin: 0 auto;
            }
            
            .member-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .member-actions {
                align-self: flex-end;
            }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Input dengan format Rupiah */
        .input-rupiah {
            position: relative;
        }
        
        .input-rupiah::before {
            content: "Rp ";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-weight: 600;
            z-index: 1;
        }
        
        .input-rupiah input {
            padding-left: 40px !important;
        }
        
        /* SweetAlert Custom Styles */
        .swal2-popup {
            border-radius: 12px !important;
        }
        
        .swal2-title {
            font-size: 1.3rem !important;
            color: var(--dark) !important;
        }
        
        .swal2-html-container {
            font-size: 0.9rem !important;
            color: var(--gray) !important;
        }
        
        .swal2-confirm {
            background-color: var(--primary) !important;
            border-radius: 8px !important;
            padding: 8px 20px !important;
        }
        
        .swal2-cancel {
            border-radius: 8px !important;
            padding: 8px 20px !important;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Report section styles */
        .report-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .report-generated {
            background-color: #E8F5E9;
            border: 1px solid #C8E6C9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .report-generated.active {
            display: block;
        }
        
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .report-summary-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .report-summary-item h4 {
            margin: 0 0 5px 0;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .report-summary-item .amount {
            font-size: 1.2rem;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üí∞</span>
                    <div>
                        <h1>Kasta</h1>
                        <div class="logo-subtitle">by ilhamdev</div>
                    </div>
                </div>
                
                <div class="nav-tabs">
                    <button class="nav-tab active" data-section="dashboard">Dashboard</button>
                    <button class="nav-tab" data-section="transactions">Transaksi</button>
                    <button class="nav-tab" data-section="members">Anggota</button>
                </div>
            </div>
        </div>
    </header>
    
    <main class="container">
        <div class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="stats-cards">
                    <div class="stat-card">
                        <h3>Saldo Kas Saat Ini</h3>
                        <div class="amount" id="currentBalance">Rp 0</div>
                        <p>Update terakhir: <span id="lastUpdate">-</span></p>
                    </div>
                    <div class="stat-card">
                        <h3>Total Pendapatan</h3>
                        <div class="amount" id="totalIncome">Rp 0</div>
                        <p>Bulan ini: <span id="monthIncome">Rp 0</span></p>
                    </div>
                    <div class="stat-card">
                        <h3>Total Pengeluaran</h3>
                        <div class="amount" id="totalExpense">Rp 0</div>
                        <p>Bulan ini: <span id="monthExpense">Rp 0</span></p>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-success" id="addIncomeBtn">
                        <span>+</span> Pendapatan
                    </button>
                    <button class="btn btn-warning" id="addExpenseBtn">
                        <span>‚àí</span> Penarikan
                    </button>
                    <button class="btn btn-primary" id="quickReportBtn">
                        üìä Laporan
                    </button>
                </div>
                
                <div class="chart-container">
                    <h2>Grafik Keuangan 6 Bulan Terakhir</h2>
                    <canvas id="financeChart"></canvas>
                </div>
                
                <div class="form-section">
                    <h2>Transaksi Terbaru</h2>
                    <div class="recent-transactions-container" id="recentTransactions">
                        <div class="empty-state">
                            <div class="empty-state-icon">üí∏</div>
                            <p>Belum ada transaksi</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Transactions Section -->
            <section id="transactions" class="section">
                <h2 class="section-title">Semua Transaksi</h2>
                
                <div class="actions">
                    <button class="btn btn-primary active" id="filterAllBtn">Semua</button>
                    <button class="btn btn-success" id="filterIncomeBtn">Pendapatan</button>
                    <button class="btn btn-warning" id="filterExpenseBtn">Pengeluaran</button>
                    <div style="flex-grow: 1;"></div>
                    <input type="month" id="monthFilter" style="padding: 8px; border-radius: 8px; border: 1px solid #E5E5EA; font-size: 0.9rem;">
                </div>
                
                <div class="form-section">
                    <div class="table-container">
                        <table class="transactions-table">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Jenis</th>
                                    <th>Keterangan</th>
                                    <th>Nominal</th>
                                    <th>Saldo</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList">
                                <!-- Data transaksi akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Laporan Section -->
                <div class="form-section">
                    <h2>Laporan Keuangan</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportStartDate">Dari Tanggal</label>
                            <input type="date" id="reportStartDate">
                        </div>
                        <div class="form-group">
                            <label for="reportEndDate">Sampai Tanggal</label>
                            <input type="date" id="reportEndDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportType">Jenis Transaksi</label>
                        <select id="reportType">
                            <option value="all">Semua Transaksi</option>
                            <option value="income">Pendapatan Saja</option>
                            <option value="expense">Pengeluaran Saja</option>
                        </select>
                    </div>
                    
                    <div class="report-actions">
                        <button class="btn btn-primary" id="generateReportBtn">Generate Laporan</button>
                    </div>
                    
                    <div class="report-generated" id="reportGenerated">
                        <h3>Laporan Berhasil Digenerate</h3>
                        <div class="report-summary" id="reportSummary">
                            <!-- Summary akan diisi oleh JavaScript -->
                        </div>
                        <button class="btn btn-success" id="sendReportBtn">üì§ Kirim Laporan via WhatsApp</button>
                    </div>
                </div>
            </section>
            
            <!-- Members Section -->
            <section id="members" class="section">
                <h2 class="section-title">Daftar Anggota</h2>
                
                <div class="actions">
                    <button class="btn btn-success" id="addMemberBtn">
                        <span>+</span> Tambah Anggota
                    </button>
                    <button class="btn btn-primary" id="sendReminderBtn">
                        üì¢ Kirim Pengingat
                    </button>
                </div>
                
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Semua</button>
                    <button class="filter-btn" data-filter="paid">Sudah Bayar</button>
                    <button class="filter-btn" data-filter="unpaid">Belum Bayar</button>
                </div>
                
                <div class="form-section">
                    <div id="membersList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <p>Belum ada anggota</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <!-- Bottom Navigation for Mobile -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-section="dashboard">
            <span class="nav-icon">üìä</span>
            <span>Dashboard</span>
        </button>
        <button class="nav-item" data-section="transactions">
            <span class="nav-icon">üí≥</span>
            <span>Transaksi</span>
        </button>
        <button class="nav-item" data-section="members">
            <span class="nav-icon">üë•</span>
            <span>Anggota</span>
        </button>
    </nav>
    
    <footer>
        <div class="container">
            <p>Dibuat dengan ‚ù§Ô∏è oleh ilhamdev</p>
            <div class="help-center">
                <button class="help-btn" id="helpBtn">
                    <span>üÜò</span> Pusat Bantuan
                </button>
            </div>
        </div>
    </footer>

    <script>
        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDuUjPXCQna7XQIC0EJ_yq_lCFvXK4Yz94",
            authDomain: "gangbiawak-d4ba7.firebaseapp.com",
            databaseURL: "https://gangbiawak-d4ba7-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gangbiawak-d4ba7",
            storageBucket: "gangbiawak-d4ba7.firebasestorage.app",
            messagingSenderId: "608737359924",
            appId: "1:608737359924:web:effb6ad16853fe663d7261"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // State aplikasi
        let transactions = [];
        let members = [];
        let currentBalance = 0;
        let financeChart = null;
        let generatedReportData = null;

        // Elemen DOM
        const navTabs = document.querySelectorAll('.nav-tab');
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.section');
        const filterButtons = document.querySelectorAll('.filter-btn');
        
        // Dashboard elements
        const currentBalanceEl = document.getElementById('currentBalance');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpenseEl = document.getElementById('totalExpense');
        const monthIncomeEl = document.getElementById('monthIncome');
        const monthExpenseEl = document.getElementById('monthExpense');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const addIncomeBtn = document.getElementById('addIncomeBtn');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const quickReportBtn = document.getElementById('quickReportBtn');
        const recentTransactions = document.getElementById('recentTransactions');
        const financeChartCanvas = document.getElementById('financeChart');
        
        // Transactions elements
        const transactionsList = document.getElementById('transactionsList');
        const filterAllBtn = document.getElementById('filterAllBtn');
        const filterIncomeBtn = document.getElementById('filterIncomeBtn');
        const filterExpenseBtn = document.getElementById('filterExpenseBtn');
        const monthFilter = document.getElementById('monthFilter');
        
        // Members elements
        const membersList = document.getElementById('membersList');
        const addMemberBtn = document.getElementById('addMemberBtn');
        const sendReminderBtn = document.getElementById('sendReminderBtn');
        
        // Report elements
        const generateReportBtn = document.getElementById('generateReportBtn');
        const sendReportBtn = document.getElementById('sendReportBtn');
        const reportGenerated = document.getElementById('reportGenerated');
        const reportSummary = document.getElementById('reportSummary');
        const reportStartDate = document.getElementById('reportStartDate');
        const reportEndDate = document.getElementById('reportEndDate');
        const reportType = document.getElementById('reportType');
        
        // Help button
        const helpBtn = document.getElementById('helpBtn');

        // Format Rupiah
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Format angka dengan pemisah ribuan (tanpa Rp)
        function formatNumber(amount) {
            return new Intl.NumberFormat('id-ID').format(amount);
        }

        // Konversi string dengan pemisah ribuan ke angka
        function parseRupiah(rupiahString) {
            return parseInt(rupiahString.replace(/\./g, ''));
        }

        // Format tanggal
        function formatDate(dateString) {
            const options = { day: '2-digit', month: 'long', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // Format tanggal singkat
        function formatShortDate(dateString) {
            const options = { day: '2-digit', month: 'short' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // Format tanggal lengkap dengan waktu
        function formatDateTime(dateString) {
            const options = { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // Tampilkan notifikasi SweetAlert dengan style yang lebih baik
        function showAlert(icon, title, text, confirmText = 'OK') {
            Swal.fire({
                icon: icon,
                title: title,
                text: text,
                confirmButtonText: confirmText,
                confirmButtonColor: '#007AFF',
                background: '#FFFFFF',
                customClass: {
                    popup: 'swal2-popup-custom'
                }
            });
        }

        // Tampilkan loading
        function showLoading(message = 'Memuat...') {
            Swal.fire({
                title: message,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }

        // Firebase Functions
        // Simpan transaksi ke Firebase
        async function saveTransactionToFirebase(transaction) {
            try {
                const transactionRef = database.ref('transactions').push();
                await transactionRef.set({
                    ...transaction,
                    id: transactionRef.key
                });
                return transactionRef.key;
            } catch (error) {
                console.error('Error saving transaction to Firebase:', error);
                throw error;
            }
        }

        // Simpan anggota ke Firebase
        async function saveMemberToFirebase(member) {
            try {
                const memberRef = database.ref('members').push();
                await memberRef.set({
                    ...member,
                    id: memberRef.key
                });
                return memberRef.key;
            } catch (error) {
                console.error('Error saving member to Firebase:', error);
                throw error;
            }
        }

        // Update anggota di Firebase
        async function updateMemberInFirebase(memberId, updates) {
            try {
                await database.ref(`members/${memberId}`).update(updates);
            } catch (error) {
                console.error('Error updating member in Firebase:', error);
                throw error;
            }
        }

        // Hapus anggota dari Firebase
        async function deleteMemberFromFirebase(memberId) {
            try {
                await database.ref(`members/${memberId}`).remove();
            } catch (error) {
                console.error('Error deleting member from Firebase:', error);
                throw error;
            }
        }

        // Load data dari Firebase
        async function loadDataFromFirebase() {
            showLoading('Memuat data...');
            
            try {
                // Load transaksi
                const transactionsSnapshot = await database.ref('transactions').once('value');
                const transactionsData = transactionsSnapshot.val();
                
                if (transactionsData) {
                    transactions = Object.values(transactionsData);
                    // Urutkan berdasarkan tanggal (terbaru dulu)
                    transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                } else {
                    transactions = [];
                }
                
                // Load anggota
                const membersSnapshot = await database.ref('members').once('value');
                const membersData = membersSnapshot.val();
                
                if (membersData) {
                    members = Object.values(membersData);
                } else {
                    members = [];
                }
                
                // Hitung saldo saat ini
                calculateCurrentBalance();
                
                // Update UI
                updateDashboard();
                updateTransactionsList();
                updateMembersList();
                
                Swal.close();
            } catch (error) {
                console.error('Error loading data from Firebase:', error);
                Swal.close();
                showAlert('error', 'Error', 'Gagal memuat data dari server.');
            }
        }

        // Hitung saldo saat ini
        function calculateCurrentBalance() {
            currentBalance = 0;
            
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    currentBalance += transaction.amount;
                } else if (transaction.type === 'expense') {
                    currentBalance -= transaction.amount;
                }
            });
        }

        // Update Dashboard
        function updateDashboard() {
            // Update saldo
            currentBalanceEl.textContent = formatRupiah(currentBalance);
            
            // Hitung total pendapatan dan pengeluaran
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalExpense = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
                
            totalIncomeEl.textContent = formatRupiah(totalIncome);
            totalExpenseEl.textContent = formatRupiah(totalExpense);
            
            // Hitung pendapatan dan pengeluaran bulan ini
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthIncome = transactions
                .filter(t => t.type === 'income' && 
                    new Date(t.date).getMonth() === currentMonth &&
                    new Date(t.date).getFullYear() === currentYear)
                .reduce((sum, t) => sum + t.amount, 0);
                
            const monthExpense = transactions
                .filter(t => t.type === 'expense' && 
                    new Date(t.date).getMonth() === currentMonth &&
                    new Date(t.date).getFullYear() === currentYear)
                .reduce((sum, t) => sum + t.amount, 0);
                
            monthIncomeEl.textContent = formatRupiah(monthIncome);
            monthExpenseEl.textContent = formatRupiah(monthExpense);
            
            // Update waktu terakhir
            if (transactions.length > 0) {
                const lastTransaction = transactions[0];
                lastUpdateEl.textContent = formatShortDate(lastTransaction.date);
            } else {
                lastUpdateEl.textContent = '-';
            }
            
            // Update transaksi terbaru
            updateRecentTransactions();
            
            // Update grafik
            updateFinanceChart();
        }

        // Update daftar transaksi terbaru di dashboard
        function updateRecentTransactions() {
            if (transactions.length === 0) {
                recentTransactions.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∏</div>
                        <p>Belum ada transaksi</p>
                    </div>
                `;
                return;
            }
            
            const recent = transactions.slice(0, 5);
            let html = '';
            
            recent.forEach(transaction => {
                const typeIcon = transaction.type === 'income' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                const amountClass = transaction.type === 'income' ? 'income' : 'expense';
                
                html += `
                    <div class="transaction-item">
                        <div>
                            <strong>${transaction.description}</strong>
                            <div style="font-size: 0.8rem; color: #8E8E93;">${formatDate(transaction.date)}</div>
                        </div>
                        <div class="${amountClass}">${typeIcon} ${formatRupiah(transaction.amount)}</div>
                    </div>
                `;
            });
            
            recentTransactions.innerHTML = html;
        }

        // Update grafik keuangan
        function updateFinanceChart() {
            if (financeChart) {
                financeChart.destroy();
            }
            
            // Siapkan data untuk 6 bulan terakhir
            const months = [];
            const incomeData = [];
            const expenseData = [];
            
            const currentDate = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthName = date.toLocaleDateString('id-ID', { month: 'short' });
                months.push(monthName);
                
                const month = date.getMonth();
                const year = date.getFullYear();
                
                const monthIncome = transactions
                    .filter(t => t.type === 'income' && 
                        new Date(t.date).getMonth() === month &&
                        new Date(t.date).getFullYear() === year)
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                const monthExpense = transactions
                    .filter(t => t.type === 'expense' && 
                        new Date(t.date).getMonth() === month &&
                        new Date(t.date).getFullYear() === year)
                    .reduce((sum, t) => sum + t.amount, 0);
                    
                incomeData.push(monthIncome);
                expenseData.push(monthExpense);
            }
            
            const ctx = financeChartCanvas.getContext('2d');
            financeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Pendapatan',
                            data: incomeData,
                            backgroundColor: '#34C759',
                            borderColor: '#30A14E',
                            borderWidth: 1
                        },
                        {
                            label: 'Pengeluaran',
                            data: expenseData,
                            backgroundColor: '#FF3B30',
                            borderColor: '#D70015',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + formatNumber(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatRupiah(context.raw);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update daftar transaksi
        function updateTransactionsList(filterType = 'all', monthFilterValue = '') {
            let filteredTransactions = [...transactions];
            
            // Filter berdasarkan jenis transaksi
            if (filterType === 'income') {
                filteredTransactions = filteredTransactions.filter(t => t.type === 'income');
            } else if (filterType === 'expense') {
                filteredTransactions = filteredTransactions.filter(t => t.type === 'expense');
            }
            
            // Filter berdasarkan bulan
            if (monthFilterValue) {
                const [year, month] = monthFilterValue.split('-');
                filteredTransactions = filteredTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getFullYear() == year && 
                           transactionDate.getMonth() + 1 == month;
                });
            }
            
            if (filteredTransactions.length === 0) {
                transactionsList.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px;">
                            <div style="color: #8E8E93;">Tidak ada transaksi</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            let runningBalance = 0;
            
            // Hitung saldo awal berdasarkan transaksi sebelum periode yang difilter
            if (monthFilterValue) {
                const [year, month] = monthFilterValue.split('-');
                const startDate = new Date(year, month - 1, 1);
                
                transactions.forEach(t => {
                    const transactionDate = new Date(t.date);
                    if (transactionDate < startDate) {
                        if (t.type === 'income') {
                            runningBalance += t.amount;
                        } else if (t.type === 'expense') {
                            runningBalance -= t.amount;
                        }
                    }
                });
            }
            
            filteredTransactions.forEach(transaction => {
                const typeText = transaction.type === 'income' ? 'Pendapatan' : 'Pengeluaran';
                const typeClass = transaction.type === 'income' ? 'income' : 'expense';
                
                // Update running balance
                if (transaction.type === 'income') {
                    runningBalance += transaction.amount;
                } else {
                    runningBalance -= transaction.amount;
                }
                
                html += `
                    <tr>
                        <td>${formatDate(transaction.date)}</td>
                        <td>${typeText}</td>
                        <td>${transaction.description}</td>
                        <td class="${typeClass}">${formatRupiah(transaction.amount)}</td>
                        <td>${formatRupiah(runningBalance)}</td>
                    </tr>
                `;
            });
            
            transactionsList.innerHTML = html;
        }

        // Update daftar anggota
        function updateMembersList(filter = 'all') {
            if (members.length === 0) {
                membersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <p>Belum ada anggota</p>
                    </div>
                `;
                return;
            }
            
            let filteredMembers = [...members];
            
            // Filter berdasarkan status pembayaran
            if (filter === 'paid') {
                filteredMembers = filteredMembers.filter(m => m.paid);
            } else if (filter === 'unpaid') {
                filteredMembers = filteredMembers.filter(m => !m.paid);
            }
            
            if (filteredMembers.length === 0) {
                membersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <p>Tidak ada anggota dengan status ini</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredMembers.forEach(member => {
                const statusClass = member.paid ? 'status-paid' : 'status-unpaid';
                const statusText = member.paid ? 'Sudah Bayar' : 'Belum Bayar';
                
                html += `
                    <div class="member-item">
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-details">${member.phone || 'No. HP tidak tersedia'}</div>
                            <div class="payment-status">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="member-actions">
                            <button class="btn btn-sm ${member.paid ? 'btn-warning' : 'btn-success'}" 
                                    onclick="togglePaymentStatus('${member.id}', ${!member.paid})">
                                ${member.paid ? 'Batalkan' : 'Tandai Lunas'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMember('${member.id}')">
                                Hapus
                            </button>
                            ${member.phone ? `<span class="wa-icon" onclick="sendWhatsAppReminder('${member.id}')">üí¨</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            membersList.innerHTML = html;
        }

        // Toggle status pembayaran anggota
        async function togglePaymentStatus(memberId, newStatus) {
            try {
                await updateMemberInFirebase(memberId, { paid: newStatus });
                
                // Update data lokal
                const memberIndex = members.findIndex(m => m.id === memberId);
                if (memberIndex !== -1) {
                    members[memberIndex].paid = newStatus;
                    updateMembersList();
                }
                
                showAlert('success', 'Berhasil', `Status pembayaran berhasil diubah.`);
            } catch (error) {
                console.error('Error updating payment status:', error);
                showAlert('error', 'Error', 'Gagal mengubah status pembayaran.');
            }
        }

        // Hapus anggota
        async function deleteMember(memberId) {
            const result = await Swal.fire({
                title: 'Hapus Anggota?',
                text: "Data anggota akan dihapus permanen.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#FF3B30',
                cancelButtonColor: '#8E8E93',
                confirmButtonText: 'Ya, Hapus!',
                cancelButtonText: 'Batal'
            });
            
            if (result.isConfirmed) {
                try {
                    await deleteMemberFromFirebase(memberId);
                    
                    // Hapus dari data lokal
                    members = members.filter(m => m.id !== memberId);
                    updateMembersList();
                    
                    showAlert('success', 'Berhasil', 'Anggota berhasil dihapus.');
                } catch (error) {
                    console.error('Error deleting member:', error);
                    showAlert('error', 'Error', 'Gagal menghapus anggota.');
                }
            }
        }

        // Kirim pengingat WhatsApp
        function sendWhatsAppReminder(memberId) {
            const member = members.find(m => m.id === memberId);
            
            if (!member || !member.phone) {
                showAlert('error', 'Error', 'Nomor telepon anggota tidak tersedia.');
                return;
            }
            
            const phoneNumber = member.phone.replace(/\D/g, ''); // Hapus karakter non-digit
            const message = `Halo ${member.name}, ini adalah pengingat untuk pembayaran kas. Terima kasih.`;
            const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(url, '_blank');
        }

        // Generate laporan keuangan
        function generateReport() {
            const startDate = reportStartDate.value;
            const endDate = reportEndDate.value;
            const type = reportType.value;
            
            if (!startDate || !endDate) {
                showAlert('warning', 'Peringatan', 'Harap pilih rentang tanggal untuk laporan.');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showAlert('warning', 'Peringatan', 'Tanggal mulai tidak boleh lebih besar dari tanggal akhir.');
                return;
            }
            
            // Filter transaksi berdasarkan rentang tanggal dan jenis
            let filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date);
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                return transactionDate >= start && transactionDate <= end;
            });
            
            if (type !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.type === type);
            }
            
            if (filteredTransactions.length === 0) {
                showAlert('info', 'Info', 'Tidak ada transaksi dalam rentang tanggal yang dipilih.');
                return;
            }
            
            // Hitung summary
            const totalIncome = filteredTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalExpense = filteredTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const netBalance = totalIncome - totalExpense;
            const transactionCount = filteredTransactions.length;
            
            // Simpan data laporan untuk ekspor PDF
            generatedReportData = {
                transactions: filteredTransactions,
                summary: {
                    totalIncome,
                    totalExpense,
                    netBalance,
                    transactionCount,
                    startDate,
                    endDate,
                    type
                }
            };
            
            // Update UI dengan summary
            reportSummary.innerHTML = `
                <div class="report-summary-item">
                    <h4>Total Pendapatan</h4>
                    <div class="amount income">${formatRupiah(totalIncome)}</div>
                </div>
                <div class="report-summary-item">
                    <h4>Total Pengeluaran</h4>
                    <div class="amount expense">${formatRupiah(totalExpense)}</div>
                </div>
                <div class="report-summary-item">
                    <h4>Saldo Bersih</h4>
                    <div class="amount ${netBalance >= 0 ? 'income' : 'expense'}">${formatRupiah(netBalance)}</div>
                </div>
                <div class="report-summary-item">
                    <h4>Jumlah Transaksi</h4>
                    <div class="amount">${transactionCount}</div>
                </div>
            `;
            
            // Tampilkan section laporan yang berhasil digenerate
            reportGenerated.classList.add('active');
            
            showAlert('success', 'Berhasil', 'Laporan berhasil digenerate.');
        }

        // Ekspor laporan ke PDF
        function exportReportToPDF() {
            if (!generatedReportData) {
                showAlert('warning', 'Peringatan', 'Tidak ada data laporan untuk diekspor.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Judul laporan
            doc.setFontSize(16);
            doc.text('LAPORAN KEUANGAN KAS', 105, 15, { align: 'center' });
            
            // Informasi periode
            doc.setFontSize(10);
            doc.text(`Periode: ${formatDate(generatedReportData.summary.startDate)} - ${formatDate(generatedReportData.summary.endDate)}`, 15, 25);
            
            if (generatedReportData.summary.type !== 'all') {
                const typeText = generatedReportData.summary.type === 'income' ? 'Pendapatan' : 'Pengeluaran';
                doc.text(`Jenis: ${typeText}`, 15, 30);
            }
            
            // Summary
            doc.setFontSize(12);
            doc.text('Ringkasan:', 15, 45);
            
            doc.setFontSize(10);
            doc.text(`Total Pendapatan: ${formatRupiah(generatedReportData.summary.totalIncome)}`, 20, 55);
            doc.text(`Total Pengeluaran: ${formatRupiah(generatedReportData.summary.totalExpense)}`, 20, 60);
            doc.text(`Saldo Bersih: ${formatRupiah(generatedReportData.summary.netBalance)}`, 20, 65);
            doc.text(`Jumlah Transaksi: ${generatedReportData.summary.transactionCount}`, 20, 70);
            
            // Tabel transaksi
            const tableColumn = ["Tanggal", "Jenis", "Keterangan", "Nominal"];
            const tableRows = [];
            
            generatedReportData.transactions.forEach(transaction => {
                const transactionDate = formatDate(transaction.date);
                const type = transaction.type === 'income' ? 'Pendapatan' : 'Pengeluaran';
                const amount = formatRupiah(transaction.amount);
                
                const transactionData = [
                    transactionDate,
                    type,
                    transaction.description,
                    amount
                ];
                
                tableRows.push(transactionData);
            });
            
            // Tambahkan tabel ke PDF
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 80,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [0, 122, 255] }
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Halaman ${i} dari ${pageCount}`, 105, doc.internal.pageSize.height - 10, { align: 'center' });
                doc.text(`Dibuat oleh Kasta App - ${new Date().toLocaleDateString('id-ID')}`, 105, doc.internal.pageSize.height - 5, { align: 'center' });
            }
            
            // Simpan PDF
            const fileName = `Laporan_Keuangan_${generatedReportData.summary.startDate}_${generatedReportData.summary.endDate}.pdf`;
            doc.save(fileName);
            
            return doc;
        }

        // Kirim laporan via WhatsApp
        function sendReportViaWhatsApp() {
            if (!generatedReportData) {
                showAlert('warning', 'Peringatan', 'Tidak ada data laporan untuk dikirim.');
                return;
            }
            
            // Buat PDF terlebih dahulu
            const pdfDoc = exportReportToPDF();
            
            // Karena kita tidak bisa langsung mengirim file PDF via WhatsApp Web,
            // kita akan memberikan opsi untuk membuka WhatsApp dengan pesan yang sudah disiapkan
            const { totalIncome, totalExpense, netBalance, transactionCount, startDate, endDate } = generatedReportData.summary;
            
            const message = `Laporan Keuangan Kas\n\n` +
                           `Periode: ${formatDate(startDate)} - ${formatDate(endDate)}\n` +
                           `Total Pendapatan: ${formatRupiah(totalIncome)}\n` +
                           `Total Pengeluaran: ${formatRupiah(totalExpense)}\n` +
                           `Saldo Bersih: ${formatRupiah(netBalance)}\n` +
                           `Jumlah Transaksi: ${transactionCount}\n\n` +
                           `*Silakan unduh file PDF yang telah dilampirkan.*`;
            
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            
            showAlert('info', 'Info', 'WhatsApp telah dibuka. Silakan pilih kontak dan lampirkan file PDF yang telah diunduh.');
        }

        // Event Listeners
        // Navigasi
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetSection = tab.getAttribute('data-section');
                
                // Update tab aktif
                navTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update section aktif
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === targetSection) {
                        section.classList.add('active');
                    }
                });
                
                // Update bottom nav
                navItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-section') === targetSection) {
                        item.classList.add('active');
                    }
                });
            });
        });

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetSection = item.getAttribute('data-section');
                
                // Update bottom nav aktif
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                // Update section aktif
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === targetSection) {
                        section.classList.add('active');
                    }
                });
                
                // Update top nav
                navTabs.forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.getAttribute('data-section') === targetSection) {
                        tab.classList.add('active');
                    }
                });
            });
        });

        // Filter anggota
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const filter = button.getAttribute('data-filter');
                
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                updateMembersList(filter);
            });
        });

        // Filter transaksi
        filterAllBtn.addEventListener('click', () => {
            filterAllBtn.classList.add('active');
            filterIncomeBtn.classList.remove('active');
            filterExpenseBtn.classList.remove('active');
            updateTransactionsList('all', monthFilter.value);
        });

        filterIncomeBtn.addEventListener('click', () => {
            filterAllBtn.classList.remove('active');
            filterIncomeBtn.classList.add('active');
            filterExpenseBtn.classList.remove('active');
            updateTransactionsList('income', monthFilter.value);
        });

        filterExpenseBtn.addEventListener('click', () => {
            filterAllBtn.classList.remove('active');
            filterIncomeBtn.classList.remove('active');
            filterExpenseBtn.classList.add('active');
            updateTransactionsList('expense', monthFilter.value);
        });

        monthFilter.addEventListener('change', () => {
            const activeFilter = document.querySelector('.actions .btn.active').id;
            let filterType = 'all';
            
            if (activeFilter === 'filterIncomeBtn') filterType = 'income';
            if (activeFilter === 'filterExpenseBtn') filterType = 'expense';
            
            updateTransactionsList(filterType, monthFilter.value);
        });

        // Tambah transaksi pendapatan
        addIncomeBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Tambah Pendapatan',
                html: `
                    <input type="date" id="incomeDate" class="swal2-input" placeholder="Tanggal" value="${new Date().toISOString().split('T')[0]}">
                    <input type="number" id="incomeAmount" class="swal2-input" placeholder="Jumlah (tanpa titik)">
                    <input type="text" id="incomeDescription" class="swal2-input" placeholder="Keterangan">
                `,
                confirmButtonText: 'Simpan',
                showCancelButton: true,
                cancelButtonText: 'Batal',
                preConfirm: () => {
                    const date = document.getElementById('incomeDate').value;
                    const amount = parseInt(document.getElementById('incomeAmount').value);
                    const description = document.getElementById('incomeDescription').value;
                    
                    if (!date || !amount || !description) {
                        Swal.showValidationMessage('Harap isi semua field');
                        return false;
                    }
                    
                    if (amount <= 0) {
                        Swal.showValidationMessage('Jumlah harus lebih dari 0');
                        return false;
                    }
                    
                    return { date, amount, description };
                }
            }).then(result => {
                if (result.isConfirmed) {
                    const { date, amount, description } = result.value;
                    
                    const transaction = {
                        type: 'income',
                        date,
                        amount,
                        description,
                        createdAt: new Date().toISOString()
                    };
                    
                    saveTransactionToFirebase(transaction)
                        .then(() => {
                            // Tambahkan ke data lokal
                            transactions.unshift({
                                ...transaction,
                                id: 'temp-' + Date.now() // ID sementara, akan diganti saat load ulang
                            });
                            
                            calculateCurrentBalance();
                            updateDashboard();
                            updateTransactionsList();
                            
                            showAlert('success', 'Berhasil', 'Pendapatan berhasil ditambahkan.');
                        })
                        .catch(error => {
                            console.error('Error saving income:', error);
                            showAlert('error', 'Error', 'Gagal menambahkan pendapatan.');
                        });
                }
            });
        });

        // Tambah transaksi pengeluaran
        addExpenseBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Tambah Penarikan/Pengeluaran',
                html: `
                    <input type="date" id="expenseDate" class="swal2-input" placeholder="Tanggal" value="${new Date().toISOString().split('T')[0]}">
                    <input type="number" id="expenseAmount" class="swal2-input" placeholder="Jumlah (tanpa titik)">
                    <input type="text" id="expenseDescription" class="swal2-input" placeholder="Keterangan">
                `,
                confirmButtonText: 'Simpan',
                showCancelButton: true,
                cancelButtonText: 'Batal',
                preConfirm: () => {
                    const date = document.getElementById('expenseDate').value;
                    const amount = parseInt(document.getElementById('expenseAmount').value);
                    const description = document.getElementById('expenseDescription').value;
                    
                    if (!date || !amount || !description) {
                        Swal.showValidationMessage('Harap isi semua field');
                        return false;
                    }
                    
                    if (amount <= 0) {
                        Swal.showValidationMessage('Jumlah harus lebih dari 0');
                        return false;
                    }
                    
                    // Cek apakah saldo mencukupi
                    if (amount > currentBalance) {
                        Swal.showValidationMessage('Saldo tidak mencukupi');
                        return false;
                    }
                    
                    return { date, amount, description };
                }
            }).then(result => {
                if (result.isConfirmed) {
                    const { date, amount, description } = result.value;
                    
                    const transaction = {
                        type: 'expense',
                        date,
                        amount,
                        description,
                        createdAt: new Date().toISOString()
                    };
                    
                    saveTransactionToFirebase(transaction)
                        .then(() => {
                            // Tambahkan ke data lokal
                            transactions.unshift({
                                ...transaction,
                                id: 'temp-' + Date.now() // ID sementara, akan diganti saat load ulang
                            });
                            
                            calculateCurrentBalance();
                            updateDashboard();
                            updateTransactionsList();
                            
                            showAlert('success', 'Berhasil', 'Pengeluaran berhasil ditambahkan.');
                        })
                        .catch(error => {
                            console.error('Error saving expense:', error);
                            showAlert('error', 'Error', 'Gagal menambahkan pengeluaran.');
                        });
                }
            });
        });

        // Tambah anggota
        addMemberBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Tambah Anggota',
                html: `
                    <input type="text" id="memberName" class="swal2-input" placeholder="Nama Anggota">
                    <input type="tel" id="memberPhone" class="swal2-input" placeholder="Nomor WhatsApp (opsional)">
                `,
                confirmButtonText: 'Simpan',
                showCancelButton: true,
                cancelButtonText: 'Batal',
                preConfirm: () => {
                    const name = document.getElementById('memberName').value;
                    const phone = document.getElementById('memberPhone').value;
                    
                    if (!name) {
                        Swal.showValidationMessage('Nama anggota harus diisi');
                        return false;
                    }
                    
                    return { name, phone, paid: false };
                }
            }).then(result => {
                if (result.isConfirmed) {
                    const { name, phone, paid } = result.value;
                    
                    const member = {
                        name,
                        phone,
                        paid,
                        joinedAt: new Date().toISOString()
                    };
                    
                    saveMemberToFirebase(member)
                        .then(() => {
                            // Tambahkan ke data lokal
                            members.push({
                                ...member,
                                id: 'temp-' + Date.now() // ID sementara, akan diganti saat load ulang
                            });
                            
                            updateMembersList();
                            
                            showAlert('success', 'Berhasil', 'Anggota berhasil ditambahkan.');
                        })
                        .catch(error => {
                            console.error('Error saving member:', error);
                            showAlert('error', 'Error', 'Gagal menambahkan anggota.');
                        });
                }
            });
        });

        // Kirim pengingat ke semua anggota yang belum bayar
        sendReminderBtn.addEventListener('click', () => {
            const unpaidMembers = members.filter(m => !m.paid && m.phone);
            
            if (unpaidMembers.length === 0) {
                showAlert('info', 'Info', 'Tidak ada anggota yang belum membayar atau tidak memiliki nomor WhatsApp.');
                return;
            }
            
            Swal.fire({
                title: 'Kirim Pengingat',
                html: `Anda akan mengirim pengingat ke <strong>${unpaidMembers.length}</strong> anggota yang belum membayar. Lanjutkan?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Kirim',
                cancelButtonText: 'Batal'
            }).then(result => {
                if (result.isConfirmed) {
                    // Buka WhatsApp untuk setiap anggota
                    unpaidMembers.forEach(member => {
                        const phoneNumber = member.phone.replace(/\D/g, '');
                        const message = `Halo ${member.name}, ini adalah pengingat untuk pembayaran kas. Terima kasih.`;
                        const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                        
                        // Buka tab baru untuk setiap anggota (mungkin dibatasi oleh browser)
                        setTimeout(() => {
                            window.open(url, '_blank');
                        }, 1000); // Delay untuk menghindari pemblokiran popup
                    });
                    
                    showAlert('success', 'Berhasil', `Pengingat telah dikirim ke ${unpaidMembers.length} anggota.`);
                }
            });
        });

        // Generate laporan
        generateReportBtn.addEventListener('click', generateReport);

        // Kirim laporan via WhatsApp
        sendReportBtn.addEventListener('click', sendReportViaWhatsApp);

        // Pusat bantuan
        helpBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Pusat Bantuan',
                html: `
                    <div style="text-align: left;">
                        <h3>Cara Menggunakan Aplikasi:</h3>
                        <p><strong>Dashboard:</strong> Lihat ringkasan keuangan dan grafik</p>
                        <p><strong>Transaksi:</strong> Kelola pemasukan dan pengeluaran kas</p>
                        <p><strong>Anggota:</strong> Kelola daftar anggota dan status pembayaran</p>
                        <p><strong>Laporan:</strong> Generate laporan keuangan dan kirim via WhatsApp</p>
                        
                        <h3>Fitur Utama:</h3>
                        <ul>
                            <li>Pencatatan transaksi keuangan</li>
                            <li>Manajemen anggota kas</li>
                            <li>Grafik keuangan interaktif</li>
                            <li>Laporan PDF dengan filter tanggal</li>
                            <li>Kirim pengingat via WhatsApp</li>
                        </ul>
                        
                        <p>Untuk bantuan lebih lanjut, hubungi developer.</p>
                    </div>
                `,
                confirmButtonText: 'Mengerti',
                width: '600px'
            });
        });

        // Set tanggal default untuk laporan (bulan ini)
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        reportStartDate.value = firstDay.toISOString().split('T')[0];
        reportEndDate.value = lastDay.toISOString().split('T')[0];
        
        // Set filter bulan default ke bulan ini
        monthFilter.value = today.toISOString().substring(0, 7);

        // Inisialisasi aplikasi
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromFirebase();
        });

        // Ekspor fungsi ke global scope untuk digunakan di HTML
        window.togglePaymentStatus = togglePaymentStatus;
        window.deleteMember = deleteMember;
        window.sendWhatsAppReminder = sendWhatsAppReminder;
    </script>
</body>
</html>